function detect_weld_median(csv_file)
    % DETECT_WELD_MEDIAN Detects weld center using Median Filter Subtraction
    % Usage: detect_weld_median('PID_02_Good.csv')
    % 1. Load Data
    try
        data = readmatrix(csv_file);
    catch ME
        error('Error reading file: %s', ME.message);
    end

    % Get dimensions
    [num_rows, num_cols] = size(data);
    
    % --- PARAMETERS (Tune these!) ---
    % Savitzky-Golay smoothing parameters
    sg_order = 3;
    sg_framelen = 15; % Must be odd
    
    % Median filter window (Background estimation)
    % Must be wider than the weld (e.g., 2x-3x weld width)
    med_window = 51; 
    
    % Peak finding parameters
    min_prominence = 0.001; % 1mm prominence
    min_width = 2;          % Min width in data points
    max_width = 50;         % Max width (reject broad walls)
    
    plot_freq = 1;

    % Loop through each row (scan)
    for i = 1:num_rows
        
        raw_signal = data(i, :);
        
        % Filter out NaNs or Infs
        if any(isnan(raw_signal)) || any(isinf(raw_signal))
             continue; 
        end
        
        if length(raw_signal) < 50
            continue;
        end

        % --- STEP 1: PRE-PROCESSING (Smoothing) ---
        % Removes high-frequency jitter
        smooth_signal = sgolayfilt(raw_signal, sg_order, sg_framelen);

        % --- STEP 2: BACKGROUND ESTIMATION ---
        % Median filter to estimate the "swing"
        background = medfilt1(smooth_signal, med_window, 'truncate');

        % --- STEP 3: SUBTRACTION ---
        % Invert: Weld is usually "closer" (smaller range), so background > signal.
        % Subtracting background - signal makes the weld a positive peak.
        flattened_signal = background - smooth_signal;

        % --- STEP 4: PEAK FINDING ---
        [pks, locs, w, p] = findpeaks(flattened_signal, ...
            'MinPeakProminence', min_prominence, ...
            'MinPeakWidth', min_width);

        % --- STEP 5: SELECTION & VALIDATION ---
        
        found_weld = false;
        best_peak_idx = -1;
        best_prominence = -1;
        
        if ~isempty(pks)
            % Filter peaks by width constraint manually if needed, 
            % though MinPeakWidth handles the lower bound.
            % Let's find the most prominent one that fits our width criteria.
            
            [sorted_prominences, sort_idx] = sort(p, 'descend');
            
            for k = 1:length(sorted_prominences)
                idx = sort_idx(k);
                width = w(idx);
                
                if width <= max_width
                    % Found a valid peak!
                    best_peak_idx = locs(idx);
                    best_prominence = p(idx);
                    best_width = width;
                    found_weld = true;
                    break; % Stop after finding the best valid one
                end
            end
        end
        
        % --- OUTPUT & VISUALIZATION ---
        if found_weld
            fprintf('Row %d: Weld Found at index %d. Height: %.4f, Width: %.1f\n', ...
                i, best_peak_idx, best_prominence, best_width);
            
            % Plot
            if mod(i, plot_freq) == 0 % Plot every 10th row
                figure(1); clf;
                subplot(2,1,1);
                plot(raw_signal, 'Color', [0.7 0.7 0.7], 'DisplayName', 'Raw'); hold on;
                plot(smooth_signal, 'b', 'LineWidth', 1, 'DisplayName', 'Smoothed');
                plot(background, 'r--', 'LineWidth', 0.5, 'DisplayName', 'Background (Median)');
                legend('Location', 'southoutside', 'Orientation', 'horizontal','NumColumns', 3); 
                title(sprintf('Scan %d: Raw & Background', i)); grid on;

                subplot(2,1,2);
                plot(flattened_signal, 'k', 'LineWidth', 1.5, 'DisplayName', 'Flattened Signal'); hold on;
                plot(best_peak_idx, flattened_signal(best_peak_idx), 'ro', 'MarkerSize', 8, 'LineWidth', 2, 'DisplayName', 'Detected Weld');
                yline(min_prominence, 'g--', 'Threshold');
                legend('Location', 'southoutside', 'Orientation', 'horizontal','NumColumns', 3); 
                title(sprintf('Scan %d: Flattened & Detection', i)); grid on;
                pause(0.01); % Pause to view
            end
            
        else
            fprintf('Row %d: NO WELD FOUND\n', i);
        end
    end
end

detect_weld_median("PID_02_Good.csv")
